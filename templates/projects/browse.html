<!-- templates/dashboard/artisan/browse_projects.html -->
{% extends 'projects/project_dashboard.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Browse Available Projects</h2>
        <div class="filters">
            <form method="get" class="d-flex gap-2">
                <select name="category" class="form-select" onchange="this.form.submit()">
                    <option value="">All Categories</option>
                    <option value="construction" {% if request.GET.category == 'construction' %}selected{% endif %}>Construction</option>
                    <option value="plumbing" {% if request.GET.category == 'plumbing' %}selected{% endif %}>Plumbing</option>
                    <option value="electrical" {% if request.GET.category == 'electrical' %}selected{% endif %}>Electrical</option>
                    <option value="carpentry" {% if request.GET.category == 'carpentry' %}selected{% endif %}>Carpentry</option>
                    <option value="masonry" {% if request.GET.category == 'masonry' %}selected{% endif %}>Masonry</option>
                    <option value="painting" {% if request.GET.category == 'painting' %}selected{% endif %}>Painting</option>
                    <option value="roofing" {% if request.GET.category == 'roofing' %}selected{% endif %}>Roofing</option>
                </select>

                <select name="sort" class="form-select" onchange="this.form.submit()">
                    <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>Newest First</option>
                    <option value="budget_high" {% if request.GET.sort == 'budget_high' %}selected{% endif %}>Highest Budget</option>
                    <option value="budget_low" {% if request.GET.sort == 'budget_low' %}selected{% endif %}>Lowest Budget</option>
                    <option value="urgent" {% if request.GET.sort == 'urgent' %}selected{% endif %}>Urgent (Short Timeline)</option>
                </select>
            </form>
        </div>
    </div>

    {% if page_obj %}
    <div class="row">
        {% for project in page_obj %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 project-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="badge bg-primary">{{ project.get_category_display }}</span>
                    <small class="text-muted">{{ project.created_at|timesince }} ago</small>
                </div>

                <div class="card-body">
                    <h5 class="card-title">{{ project.title }}</h5>
                    <p class="card-text text-truncate" style="max-height: 60px;">{{ project.description }}</p>

                    <div class="project-meta mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <small><i class="fas fa-map-marker-alt"></i> {{ project.location }}</small>
                            <small><i class="fas fa-clock"></i> {{ project.timeline_days }} days</small>
                        </div>

                        <div class="budget-range mb-2">
                            <small class="text-success fw-bold">
                                <i class="fas fa-money-bill-wave"></i>
                                KES {{ project.budget_range_min|floatformat:0 }} - {{ project.budget_range_max|floatformat:0 }}
                            </small>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-user"></i> {{ project.client.username }}
                            </small>
                            <small class="text-muted">
                                <i class="fas fa-gavel"></i> {{ project.bids.count }} bids
                            </small>
                        </div>
                    </div>
                </div>

                <div class="card-footer bg-transparent">
                    <div class="d-grid gap-2">
                        <a href="{% url 'projects:detail' project.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-eye"></i> View Details
                        </a>

                        {% if project.has_bid_from_user %}
                            <button class="btn btn-secondary" disabled>
                                <i class="fas fa-check-circle"></i> Bid Submitted
                            </button>
                        {% else %}
                            <a href="{% url 'projects:bid_create' project.id %}" class="btn btn-success">
                                <i class="fas fa-paper-plane"></i> Submit Bid
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Project pagination" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">&laquo; First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
                </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Last &raquo;</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="text-center py-5">
        <div class="empty-state">
            <i class="fas fa-hard-hat fa-4x text-muted mb-3"></i>
            <h4>No Projects Available</h4>
            <p class="text-muted">There are currently no open projects matching your criteria.</p>
            <a href="{% url 'projects:browse' %}" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Clear Filters
            </a>
        </div>
    </div>
    {% endif %}
</div>

<style>
.project-card {
    transition: transform 0.2s, box-shadow 0.2s;
    border: 1px solid #e0e0e0;
}

.project-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.card-text {
    color: #666;
    font-size: 0.9rem;
}

.project-meta small {
    font-size: 0.8rem;
}

.empty-state {
    max-width: 400px;
    margin: 0 auto;
}
</style>

<script>
// Quick bid functionality
function submitQuickBid(projectId) {
    const bidAmount = prompt('Enter your bid amount (KES):');
    if (bidAmount && !isNaN(bidAmount)) {
        // Submit via AJAX or redirect
        window.location.href = `/projects/${projectId}/bid/?amount=${bidAmount}`;
    }
}

// Filter projects by skills
function filterBySkills() {
    const skills = document.getElementById('skillsFilter').value.toLowerCase();
    const cards = document.querySelectorAll('.project-card');

    cards.forEach(card => {
        const skillsText = card.querySelector('.card-text').textContent.toLowerCase();
        if (skillsText.includes(skills) || skills === '') {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}
</script>
{% endblock %}